# ğŸ‘ KurbanCebimde Backend Makefile
# Bu dosya backend iÃ§in kolay komutlar saÄŸlar

.PHONY: help install test lint lint-fix env start migrate setup-db security docs clean

# VarsayÄ±lan hedef
help: ## YardÄ±m mesajÄ±nÄ± gÃ¶ster
	@echo "ğŸ‘ KurbanCebimde Backend Makefile"
	@echo "=================================="
	@echo ""
	@echo "KullanÄ±labilir komutlar:"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}' $(MAKEFILE_LIST)

# Kurulum
install: ## Dependencies yÃ¼kle
	@echo "ğŸ“¦ Dependencies yÃ¼kleniyor..."
	pip install -r requirements.txt

install-dev: ## Development dependencies yÃ¼kle
	@echo "ğŸ“¦ Development dependencies yÃ¼kleniyor..."
	pip install -r requirements.txt
	pip install pytest pytest-asyncio pytest-cov black isort flake8 mypy bandit

# Test
test: ## Testleri Ã§alÄ±ÅŸtÄ±r
	@echo "ğŸ§ª Testler Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor..."
	pytest tests/ -v

test-cov: ## Test coverage ile Ã§alÄ±ÅŸtÄ±r
	@echo "ğŸ§ª Test coverage Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor..."
	pytest tests/ -v --cov=app --cov-report=html --cov-report=term

test-watch: ## Testleri watch modunda Ã§alÄ±ÅŸtÄ±r
	@echo "ğŸ§ª Testler watch modunda Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor..."
	pytest tests/ -v --watch

# Linting
lint: ## Linting yap
	@echo "ğŸ” Linting yapÄ±lÄ±yor..."
	black --check .
	isort --check-only .
	flake8 . --max-line-length=127
	mypy . --ignore-missing-imports

lint-fix: ## Linting dÃ¼zeltmeleri yap
	@echo "ğŸ”§ Linting dÃ¼zeltmeleri yapÄ±lÄ±yor..."
	black .
	isort .
	flake8 . --max-line-length=127

# Environment
env: ## Environment dosyasÄ± oluÅŸtur
	@echo "ğŸ”§ Environment dosyasÄ± oluÅŸturuluyor..."
	@if [ ! -f .env ]; then \
		cp env.example .env; \
		echo "âœ… .env dosyasÄ± oluÅŸturuldu"; \
		echo "ğŸ“ LÃ¼tfen .env dosyasÄ±nÄ± dÃ¼zenleyin"; \
	else \
		echo "âš ï¸  .env dosyasÄ± zaten mevcut"; \
	fi

# Server
start: ## Development server baÅŸlat
	@echo "ğŸš€ Development server baÅŸlatÄ±lÄ±yor..."
	uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

start-prod: ## Production server baÅŸlat
	@echo "ğŸš€ Production server baÅŸlatÄ±lÄ±yor..."
	uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers 4

# Database
migrate: ## Database migration'larÄ± Ã§alÄ±ÅŸtÄ±r
	@echo "ğŸ—„ï¸ Database migration'larÄ± Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor..."
	alembic upgrade head

create-migration: ## Yeni migration oluÅŸtur
	@echo "ğŸ“ Yeni migration oluÅŸturuluyor..."
	@read -p "Migration mesajÄ±nÄ± girin: " message; \
	alembic revision --autogenerate -m "$$message"

setup-db: ## Database kurulumu
	@echo "ğŸ—„ï¸ Database kurulumu..."
	python -c "from app.main import create_tables; create_tables()"
	python create_admin.py

# GÃ¼venlik
security: ## GÃ¼venlik kontrolÃ¼
	@echo "ğŸ”’ GÃ¼venlik kontrolÃ¼ yapÄ±lÄ±yor..."
	bandit -r . -f json -o bandit-report.json
	@echo "ğŸ“Š GÃ¼venlik raporu: bandit-report.json"

# DokÃ¼mantasyon
docs: ## API dokÃ¼mantasyonu
	@echo "ğŸ“š API dokÃ¼mantasyonu:"
	@echo "  Swagger UI: http://localhost:8000/docs"
	@echo "  ReDoc: http://localhost:8000/redoc"

# Temizlik
clean: ## Cache ve geÃ§ici dosyalarÄ± temizle
	@echo "ğŸ§¹ Temizlik yapÄ±lÄ±yor..."
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -delete
	find . -type d -name "*.egg-info" -exec rm -rf {} +
	rm -rf .pytest_cache
	rm -rf .coverage
	rm -rf htmlcov
	rm -rf dist
	rm -rf build

# Docker
docker-build: ## Docker image oluÅŸtur
	@echo "ğŸ³ Docker image oluÅŸturuluyor..."
	docker build -t kurban-cebimde-api .

docker-run: ## Docker container Ã§alÄ±ÅŸtÄ±r
	@echo "ğŸ³ Docker container Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor..."
	docker run -p 8000:8000 kurban-cebimde-api

# CI/CD
ci: ## CI pipeline komutlarÄ±
	@echo "ğŸš€ CI pipeline Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor..."
	$(MAKE) install-dev
	$(MAKE) lint
	$(MAKE) test-cov
	$(MAKE) security

# Development
dev: ## Development ortamÄ± kurulumu
	@echo "ğŸ”§ Development ortamÄ± kuruluyor..."
	$(MAKE) install-dev
	$(MAKE) env
	$(MAKE) setup-db
	@echo "âœ… Development ortamÄ± hazÄ±r!"
	@echo "ğŸš€ Server baÅŸlatmak iÃ§in: make start"

# Production
prod: ## Production ortamÄ± kurulumu
	@echo "ğŸš€ Production ortamÄ± kuruluyor..."
	$(MAKE) install
	$(MAKE) migrate
	@echo "âœ… Production ortamÄ± hazÄ±r!"
	@echo "ğŸš€ Server baÅŸlatmak iÃ§in: make start-prod"

# Monitoring
monitor: ## Sistem durumunu kontrol et
	@echo "ğŸ“Š Sistem durumu:"
	@echo "  Health: http://localhost:8000/health"
	@echo "  Status: http://localhost:8000/api/monitor/status"
	@echo "  System: http://localhost:8000/api/monitor/system"

# Test endpoints
test-endpoints: ## Test endpoint'lerini Ã§alÄ±ÅŸtÄ±r
	@echo "ğŸ§ª Test endpoint'leri:"
	@echo "  Root: http://localhost:8000/api/test/v1/"
	@echo "  Notification: http://localhost:8000/api/test/v1/notification"
	@echo "  Certificate: http://localhost:8000/api/test/v1/certificate"
	@echo "  Integration: http://localhost:8000/api/test/v1/integration"

# Error testing
error-test: ## Error test endpoint'lerini Ã§alÄ±ÅŸtÄ±r
	@echo "ğŸš¨ Error test endpoint'leri:"
	@echo "  Root: http://localhost:8000/api/error-test/v1/"
	@echo "  Random: http://localhost:8000/api/error-test/v1/random"
	@echo "  Rate Limit: http://localhost:8000/api/error-test/v1/rate_limit"

# All
all: ## TÃ¼m iÅŸlemleri Ã§alÄ±ÅŸtÄ±r
	@echo "ğŸš€ TÃ¼m iÅŸlemler Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor..."
	$(MAKE) install-dev
	$(MAKE) env
	$(MAKE) lint
	$(MAKE) test-cov
	$(MAKE) security
	@echo "âœ… TÃ¼m iÅŸlemler tamamlandÄ±!"
